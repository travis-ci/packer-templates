---
description: Travis play build env template
variables:
  travis_cookbooks_branch: "precise-stable"
  travis_cookbooks_sha: ""
  gce_account_file: "{{ env `GCE_ACCOUNT_FILE` }}"
  gce_image_name: "travis-play-trusty-{{ timestamp }}"
  # gce_image_name: "travis-play-precise-{{ timestamp }}"
  gce_project_id: "{{ env `GCE_PROJECT_ID` }}"
builders:
- type: googlecompute
  name: googlecompute
  communicator: ssh
  ssh_timeout: 10m
  ssh_port: 22
  image_description: Travis play
  account_file: "{{ user `gce_account_file` }}"
  project_id: "{{ user `gce_project_id` }}"
  source_image: ubuntu-1404-trusty-v20150909a
  # source_image: ubuntu-1204-precise-v20150910
  zone: us-central1-a
  image_name: "{{ user `gce_image_name` }}"
  machine_type: n1-standard-4
  disk_size: 20
  tags:
  - ci
  - play
provisioners:
- type: shell-local
  command: if [ -f .packer-template ] ; then git checkout -- . ; fi ; ./bin/dump-git-meta
- type: file
  source: tmp/git-meta
  destination: "/var/tmp/git-meta"
- type: shell
  inline: sleep 10
  only:
  - googlecompute
- type: file
  source: packer-assets/ubuntu-precise-ci-packages.txt
  destination: "/var/tmp/packages.txt"
- type: shell
  inline: apt-get update -yqq ; apt-get install -y gnupg2 build-essential autoconf
  environment_vars:
  - DEBIAND_FRONTEND=noninteractive
- type: file
  source: packer-assets/ubuntu-trusty-normal-purge.txt
  destination: "/var/tmp/purge.txt"
- type: shell
  scripts:
  - packer-scripts/packer-env-dump
  - packer-scripts/pre-chef-bootstrap
  - packer-scripts/remove-vagrant-user
  - packer-scripts/clone-travis-cookbooks
  environment_vars:
  - TRAVIS_COOKBOOKS_BRANCH={{ user `travis_cookbooks_branch` }}
  - TRAVIS_COOKBOOKS_SHA={{ user `travis_cookbooks_sha` }}
  execute_command: "{{ .Vars }} exec sudo -E -S bash '{{ .Path }}'"
- type: chef-solo
  execute_command: '{{if .Sudo}}sudo {{end}}chef-solo --no-color -c {{.ConfigPath}} -j {{.JsonPath}} || echo "Oh Noes: exit $?"'
  config_template: chef-solo.rb.tmpl
  cookbook_paths:
  - cookbooks
  remote_cookbook_paths:
  - "/tmp/chef-stuff/travis-cookbooks/cookbooks"
  - "/tmp/chef-stuff/travis-cookbooks/community-cookbooks"
  - "/tmp/chef-stuff/travis-cookbooks/ci_environment"
  json:
    travis_packer_templates:
      job_board:
        languages:
        - ruby
        - python
        - whatever
  run_list:
  - recipe[travis_packer_templates]
- type: shell
  inline: while true ; do date -u ; echo tick ; sleep 60 ; done
  only:
  - googlecompute
