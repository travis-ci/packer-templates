---
description: Travis CI Red Hat Universal Base Image 8 build env template
variables:
  chef_log_level: info
  docker_repository: travisci/ci-rhel-8
  docker_tag: packer-{{ timestamp }}-<%= git_desc %>
  gce_account_file: "{{ env `GCE_ACCOUNT_FILE` }}"
  gce_project_id: "{{ env `GCE_PROJECT_ID` }}"
  image_name: travis-ci-rhel-8-{{ timestamp }}-<%= git_desc %>
  travis_cookbooks_branch: "{{ env `TRAVIS_COOKBOOKS_BRANCH` }}"
  travis_cookbooks_edge_branch: master
  travis_cookbooks_sha: "{{ env `TRAVIS_COOKBOOKS_SHA` }}"
  travis_uid: "{{ env `TRAVIS_UID` }}"
  travis_subnet_id: "{{ env `TRAVIS_SUBNET_ID` }}"
  travis_vpc_id: "{{ env `TRAVIS_VPC_ID` }}"
  travis_source_ami: "{{ env `TRAVIS_SOURCE_AMI` }}"
builders:
- type: docker
  name: docker
  ssh_pty: true
  image: "redhat/ubi8"
  run_command:
  - -d
  - -v
  - <%= Dir.pwd %>/tmp/packer-builder-tmp:/tmp
  - --privileged=true
    # Disable on bionic, it's only supported overlay fs on xfs with quota
    #  - --storage-opt=size=11G
  - "{{ .Image }}"
  - /sbin/init
  commit: true
provisioners:
- type: shell
  scripts:
  - packer-scripts/pre-chef-bootstrap-rhel
  - packer-scripts/run-serverspecs-rhel
  - packer-scripts/clone-travis-cookbooks-rhel
  environment_vars:
  - SKIP_APT_UPGRADE=1
  - TRAVIS_COOKBOOKS_BRANCH={{ user `travis_cookbooks_branch` }}
  - TRAVIS_COOKBOOKS_SHA={{ user `travis_cookbooks_sha` }}
  - TRAVIS_UID={{ user `travis_uid` }}
  execute_command: "{{ .Vars }} exec bash '{{ .Path }}'"
# - type: chef-solo
#   version: 17.6.18
#   config_template: chef-solo.rb.tmpl
#   <% if ENV['CHEF_PROFILING'] %>
#   execute_command: "{{if .Sudo}}sudo {{end}}CI=yes chef-solo --chef-license accept-silent -F doc --no-color -c {{.ConfigPath}} -j {{.JsonPath}}"
#   <% else %>
#   execute_command: "{{if .Sudo}}sudo {{end}}CI=yes chef-solo --chef-license accept-silent --no-color -c {{.ConfigPath}} -j {{.JsonPath}}"
#   <% end %>
#   <% if ENV['BUILDER'] == "lxd" %>
#   # packer lxd builder copy cookbooks to wrong directory
#   execute_command: "rsync -a --delete-after /tmp/packer-chef-solo/cookbooks-0/cookbooks/ /tmp/packer-chef-solo/cookbooks-0/ && \
#   {{if .Sudo}}sudo {{end}}chef-solo --chef-license accept-silent --no-color -c {{.ConfigPath}} -j {{.JsonPath}}"
#   <% end %>
#   cookbook_paths:
#   - cookbooks
#   <% if ENV['COOKBOOKS_LOCAL'] && ENV['TRAVIS_COOKBOOKS_DIR'] %>
#   - <%= ENV['TRAVIS_COOKBOOKS_DIR'] %>/cookbooks
#   - <%= ENV['TRAVIS_COOKBOOKS_DIR'] %>/community-cookbooks
#   <% else %>
#   remote_cookbook_paths:
#   - /tmp/chef-stuff/travis-cookbooks/cookbooks
#   - /tmp/chef-stuff/travis-cookbooks/community-cookbooks
#   <% end %>
#   run_list:
#   - recipe[travis_ci_ubuntu_2004]
#   <% if ENV['CHEF_PROFILING'] %>
#   - recipe[poise-profiler]
#   <% end %>
